<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://robertylewis.com/mathlib/css/lean.css" >
  <link rel="shortcut icon" href="https://robertylewis.com/mathlib/img/favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Merriweather&family=Open+Sans&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    

	<script>
                function buildShortcutsForStructures(names) {
                        const o = {}
                        names.forEach(name => o[name] = `\\mathbb\{${name}\}`)
                        return o
                }
		MathJax = {
			  tex: {
                                  macros: {
                                          ...buildShortcutsForStructures(["R", "Q", "Z", "N", "C"]),
                                  },
				      inlineMath: [['$', '$'], ['\\(', '\\)']]
				    },
		};
	</script>
	<script type="text/javascript" id="MathJax-script" async
		  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
	</script>

	<title>The equation compiler and using_well_founded</title>
  </head>
  <body>
  <nav class="navbar navbar-expand-lg navbar-light bg-gradient-light d-md-none">
    <div class="d-flex flex-grow-1">
		<a class="navbar-brand" href="https://robertylewis.com/mathlibindex.html">Lean Community
    </a>
    </div>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  </nav>
  <div class="container-fluid"><div class="row">
    <nav id="navbar" class="col-md-3 col-xl-2 d-md-block bg-light sidebar collapse navbar-light pb-4">
      <div class="d-none d-md-block mt-4"><a class="navbar-brand" href="https://robertylewis.com/mathlibindex.html">Lean Community</a></div>
      <div class="row">
      <div class="col-6 col-md-12">
        <h6 class="sidebar-heading px-3 mt-4 mb-1">Community</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="d-block" href="https://leanprover.zulipchat.com/">Zulip chat</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://github.com/leanprover-community/mathlib">GitHub</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibmeet.html">Community information</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibpapers.html">Papers about Lean</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathliblean_projects.html">Projects using Lean</a></li>
        </ul>
      </div><div class="col-6 col-md-12">
        <h6 class="sidebar-heading px-3 mt-4 mb-1">Installation</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibget_started.html">Get started</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibinstall/debian.html">Debian/Ubuntu installation</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibinstall/linux.html">Generic Linux installation</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibinstall/macos.html">MacOS installation</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibinstall/windows.html">Windows installation</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://leanprover-community.github.io/lean-web-editor">Online version (no installation)</a></li>
        </ul>
      </div><div class="col-6 col-md-12">
        <h6 class="sidebar-heading px-3 mt-4 mb-1">Documentation</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathliblearn.html">Learning resources (start here)</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://leanprover-community.github.io/mathlib_docs">API documentation</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibextras/calc.html">calc mode</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibextras/conv.html">conv mode</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibextras/simp.html">simplifier</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibextras/tactic_writing.html">tactic writing tutorial</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibextras/well_founded_recursion.html">well-founded recursion</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibleanproject.html">leanproject</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibtoolchain.html">How pieces fit together</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibmwe.html">About MWEs</a></li>
        </ul>
      </div><div class="col-6 col-md-12">
        <h6 class="sidebar-heading px-3 mt-4 mb-1">Library overviews</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibmathlib-overview.html">Library overview</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibundergrad.html">Undergraduate maths</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlib100.html">Wiedijk's 100 theorems</a></li>
        </ul>
      </div><div class="col-6 col-md-12">
        <h6 class="sidebar-heading px-3 mt-4 mb-1">Theory docs</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibtheories/category_theory.html">Category theory</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibtheories/linear_algebra.html">Linear algebra</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibtheories/naturals.html">Natural numbers</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibtheories/sets.html">Sets and set-like objects</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibtheories/topology.html">Topology</a></li>
        </ul>
      </div><div class="col-6 col-md-12">
        <h6 class="sidebar-heading px-3 mt-4 mb-1">Contributing</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibcontribute/index.html">Pull request lifecycle</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibcontribute/naming.html">Naming conventions</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibcontribute/style.html">Code style guideline</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibcontribute/doc.html">Documentation style</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibci.html">CI for 3rd party projects</a></li>
        
          <li class="nav-item"><a class="d-block" href="https://robertylewis.com/mathlibmathlib_stats.html">Contribution statistics</a></li>
        </ul>
      </div>
      </div>
    </nav>
  <main class="col-md-9 col-xl-8 px-md-4">
    <div class="mx-auto mt-4" style="max-width: 60em">
	  
<h1 id="the-equation-compiler-and-using_well_founded" class="markdown-heading">The equation compiler and using_well_founded <a class="hover-link" href="#the-equation-compiler-and-using_well_founded">#</a></h1>
<p>To define functions and proofs recursively you can use the equation compiler, if you have a well founded relation on that type</p>
<p>For example the definition of gcd on naturals uses well founded recursion</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">gcd</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="mi">0</span>        <span class="n">y</span> <span class="o">:=</span> <span class="n">y</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="n">y</span> <span class="o">:=</span> <span class="k">have</span> <span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">succ</span> <span class="n">x</span><span class="o">,</span> <span class="k">from</span> <span class="n">mod_lt</span> <span class="bp">_</span> <span class="err">$</span> <span class="n">succ_pos</span> <span class="bp">_</span><span class="o">,</span>
                <span class="n">gcd</span> <span class="o">(</span><span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span>
</pre></div>

<p>Because &lt; is a well founded relation on naturals, and because <code>y % succ x &lt; succ x</code> this recursive function is well_founded.</p>
<p>Whenever you use the equation compiler there will be a default well founded relation on the type being recursed on and the equation compiler will automatically attempt to prove the function is well founded.</p>
<p>When the equation compiler fails, there are two main causes.</p>
<ol>
<li>It has failed to prove the required inequality.</li>
<li>It is not using the correct well founded relation.</li>
</ol>
<h2 id="proving-required-inequality" class="markdown-heading">Proving required inequality <a class="hover-link" href="#proving-required-inequality">#</a></h2>
<p>If we modify the gcd example above, by removing the <code>have</code>, we get an error.</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">gcd</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="mi">0</span>        <span class="n">y</span> <span class="o">:=</span> <span class="n">y</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">gcd</span> <span class="o">(</span><span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span>failed to prove recursive application is decreasing, well founded relation
  @has_well_founded.r (Σ&#39; (a : ℕ), ℕ)
    (@psigma.has_well_founded ℕ (λ (a : ℕ), ℕ) (@has_well_founded_of_has_sizeof ℕ nat.has_sizeof)
       (λ (a : ℕ), @has_well_founded_of_has_sizeof ℕ nat.has_sizeof))
Possible solutions:
  - Use &#39;using_well_founded&#39; keyword in the end of your definition to specify tactics for synthesizing well founded relations and decreasing proofs.
  - The default decreasing tactic uses the &#39;assumption&#39; tactic, thus hints (aka local proofs) can be provided using &#39;have&#39;-expressions.
The nested exception contains the failure state for the decreasing tactic.
nested exception message:
failed
state:
gcd : (Σ&#39; (a : ℕ), ℕ) → ℕ,
x y : ℕ
⊢ y % succ x &lt; succ x
</pre></div>

<p>The error message has given us a goal, <code>y % succ x &lt; succ x</code>. Including a proof of this goal as part of our definition using <code>have</code> removes the error.</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">gcd</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="mi">0</span>        <span class="n">y</span> <span class="o">:=</span> <span class="n">y</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="n">y</span> <span class="o">:=</span> <span class="k">have</span> <span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">succ</span> <span class="n">x</span><span class="o">,</span> <span class="k">from</span> <span class="n">mod_lt</span> <span class="bp">_</span> <span class="err">$</span> <span class="n">succ_pos</span> <span class="bp">_</span><span class="o">,</span>
                <span class="n">gcd</span> <span class="o">(</span><span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span>
</pre></div>

<p>Note that the <code>have</code> must not be in tactics mode, i.e. inside any <code>begin</code> <code>end</code>. If you are in tactics mode, there is the option of putting the <code>have</code> statement inside the exact statement, as in the following example.</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">gcd</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="mi">0</span>        <span class="n">y</span> <span class="o">:=</span> <span class="n">y</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="n">y</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">exact</span> <span class="k">have</span> <span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">succ</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">mod_lt</span> <span class="bp">_</span> <span class="o">(</span><span class="n">succ_pos</span> <span class="bp">_</span><span class="o">),</span>
  <span class="n">gcd</span> <span class="o">(</span><span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span>
<span class="kn">end</span>
</pre></div>

<h2 id="order-of-arguments" class="markdown-heading">order of arguments <a class="hover-link" href="#order-of-arguments">#</a></h2>
<p>Sometimes the default relation the equation compiler uses is not the correct one. For example swapping the order of x and y in the above example causes a failure</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">gcd</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="n">y</span> <span class="mi">0</span>        <span class="o">:=</span> <span class="n">y</span>
<span class="bp">|</span> <span class="n">y</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="k">have</span> <span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">succ</span> <span class="n">x</span><span class="o">,</span> <span class="k">from</span> <span class="n">mod_lt</span> <span class="bp">_</span> <span class="err">$</span> <span class="n">succ_pos</span> <span class="bp">_</span><span class="o">,</span>
                <span class="n">gcd</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span><span class="o">)</span>
</pre></div>

<p>Now the error message is asking us to prove <code>succ x &lt; y</code>. This is because by default the equation compiler tries to recurse on the first argument. More precisely, the relation that the equation compiler tries to use in this example is on the type of pairs of natural numbers <code>Σ&#x27; (a : ℕ), ℕ</code>, and it uses a lexicographical relation where the pair <code>⟨a, b⟩ ≺ ⟨c, d⟩</code> iff <code>a &lt; c ∨ (a = c ∧ b &lt; d)</code> This situation can be resolved, either by changing the order of the arguments or by specifying a <code>rel_tac</code> as decribed later in this doc.</p>
<p>Sometimes moving an argument outside of the equation compiler, can help the equation compiler prove a recursion is well_founded. For example the following proof from <code>data.nat.prime</code> fails.</p>
<div class="highlight"><pre><span></span><span class="kn">lemma</span> <span class="n">prod_factors</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span><span class="o">),</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">list</span><span class="bp">.</span><span class="n">prod</span> <span class="o">(</span><span class="n">factors</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="mi">0</span>       <span class="n">h</span> <span class="o">:=</span> <span class="o">(</span><span class="n">lt_irrefl</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">elim</span> <span class="n">h</span>
<span class="bp">|</span> <span class="mi">1</span>       <span class="n">h</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">|</span> <span class="n">n</span><span class="bp">@</span><span class="o">(</span><span class="n">k</span><span class="bp">+</span><span class="mi">2</span><span class="o">)</span> <span class="n">h</span> <span class="o">:=</span>
  <span class="k">let</span> <span class="n">m</span> <span class="o">:=</span> <span class="n">min_fac</span> <span class="n">n</span> <span class="k">in</span> <span class="k">have</span> <span class="n">n</span> <span class="bp">/</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="o">:=</span> <span class="n">factors_lemma</span><span class="o">,</span>
  <span class="k">show</span> <span class="n">list</span><span class="bp">.</span><span class="n">prod</span> <span class="o">(</span><span class="n">m</span> <span class="bp">::</span> <span class="n">factors</span> <span class="o">(</span><span class="n">n</span> <span class="bp">/</span> <span class="n">m</span><span class="o">))</span> <span class="bp">=</span> <span class="n">n</span><span class="o">,</span> <span class="k">from</span>
  <span class="k">have</span> <span class="n">h₁</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">/</span> <span class="n">m</span> <span class="o">:=</span>
    <span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">h</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">n</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">m</span> <span class="o">:=</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">div_eq_iff_eq_mul_left</span> <span class="o">(</span><span class="n">min_fac_pos</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">min_fac_dvd</span> <span class="bp">_</span><span class="o">))</span><span class="bp">.</span><span class="mi">1</span> <span class="n">h</span><span class="o">,</span>
    <span class="k">by</span> <span class="n">rw</span> <span class="n">zero_mul</span> <span class="n">at</span> <span class="n">this</span><span class="bp">;</span> <span class="n">exact</span> <span class="o">(</span><span class="k">show</span> <span class="n">k</span> <span class="bp">+</span> <span class="mi">2</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span> <span class="k">from</span> <span class="n">dec_trivial</span><span class="o">)</span> <span class="n">this</span><span class="o">,</span>
  <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">list</span><span class="bp">.</span><span class="n">prod_cons</span><span class="o">,</span> <span class="n">prod_factors</span> <span class="bp">_</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">mul_div_cancel&#39;</span> <span class="o">(</span><span class="n">min_fac_dvd</span> <span class="bp">_</span><span class="o">)]</span>
</pre></div>

<p>But moving the <code>h</code> into a lambda after the <code>:=</code> makes it work</p>
<div class="highlight"><pre><span></span><span class="kn">lemma</span> <span class="n">prod_factors</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span><span class="o">),</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">list</span><span class="bp">.</span><span class="n">prod</span> <span class="o">(</span><span class="n">factors</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="mi">0</span>       <span class="o">:=</span> <span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="o">(</span><span class="n">lt_irrefl</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">elim</span> <span class="n">h</span>
<span class="bp">|</span> <span class="mi">1</span>       <span class="o">:=</span> <span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">rfl</span>
<span class="bp">|</span> <span class="n">n</span><span class="bp">@</span><span class="o">(</span><span class="n">k</span><span class="bp">+</span><span class="mi">2</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">h</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">m</span> <span class="o">:=</span> <span class="n">min_fac</span> <span class="n">n</span> <span class="k">in</span> <span class="k">have</span> <span class="n">n</span> <span class="bp">/</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="o">:=</span> <span class="n">factors_lemma</span><span class="o">,</span>
  <span class="k">show</span> <span class="n">list</span><span class="bp">.</span><span class="n">prod</span> <span class="o">(</span><span class="n">m</span> <span class="bp">::</span> <span class="n">factors</span> <span class="o">(</span><span class="n">n</span> <span class="bp">/</span> <span class="n">m</span><span class="o">))</span> <span class="bp">=</span> <span class="n">n</span><span class="o">,</span> <span class="k">from</span>
  <span class="k">have</span> <span class="n">h₁</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">/</span> <span class="n">m</span> <span class="o">:=</span>
    <span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">h</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">n</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">m</span> <span class="o">:=</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">div_eq_iff_eq_mul_left</span> <span class="o">(</span><span class="n">min_fac_pos</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">min_fac_dvd</span> <span class="bp">_</span><span class="o">))</span><span class="bp">.</span><span class="mi">1</span> <span class="n">h</span><span class="o">,</span>
    <span class="k">by</span> <span class="n">rw</span> <span class="n">zero_mul</span> <span class="n">at</span> <span class="n">this</span><span class="bp">;</span> <span class="n">exact</span> <span class="o">(</span><span class="k">show</span> <span class="n">k</span> <span class="bp">+</span> <span class="mi">2</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span> <span class="k">from</span> <span class="n">dec_trivial</span><span class="o">)</span> <span class="n">this</span><span class="o">,</span>
  <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">list</span><span class="bp">.</span><span class="n">prod_cons</span><span class="o">,</span> <span class="n">prod_factors</span> <span class="bp">_</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">mul_div_cancel&#39;</span> <span class="o">(</span><span class="n">min_fac_dvd</span> <span class="bp">_</span><span class="o">)]</span>
</pre></div>

<p>This is because for some reason, in the first example, the equation compiler tries to use the always false relation.</p>
<p>Conjecture : this is because the type of <code>h</code> depends on <code>n</code> and the equation compiler can only synthesize useful relations on non dependent products</p>
<h2 id="using_well_founded-rel_tac" class="markdown-heading">using_well_founded rel_tac <a class="hover-link" href="#using_well_founded-rel_tac">#</a></h2>
<p>Sometimes you need to change the well founded relation to prove that a recursion is well founded. To do this you need a <code>has_well_founded</code> instance. This is a structure with two fields, a relation and a proof that this relation is well founded. The easiest way to define a well founded relation is using a function to the natural numbers. For example on multisets the relation <code>λ s t, card s &lt; card t</code> is a well founded relation.</p>
<p>The following proof in <code>data.multiset</code> uses this relation.</p>
<div class="highlight"><pre><span></span><span class="bp">@</span><span class="o">[</span><span class="n">elab_as_eliminator</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">strong_induction_on</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">multiset</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">Sort</span><span class="bp">*</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">∀</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">multiset</span> <span class="n">α</span><span class="o">),</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="bp">∀</span><span class="n">t</span> <span class="bp">&lt;</span> <span class="n">s</span><span class="o">,</span> <span class="n">p</span> <span class="n">t</span><span class="o">)</span> <span class="bp">→</span> <span class="n">p</span> <span class="n">s</span><span class="o">)</span> <span class="bp">→</span> <span class="n">p</span> <span class="n">s</span>
<span class="bp">|</span> <span class="n">s</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">ih</span><span class="o">,</span> <span class="n">ih</span> <span class="n">s</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">t</span> <span class="n">h</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">card</span> <span class="n">t</span> <span class="bp">&lt;</span> <span class="n">card</span> <span class="n">s</span><span class="o">,</span> <span class="k">from</span> <span class="n">card_lt_of_lt</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">strong_induction_on</span> <span class="n">t</span> <span class="n">ih</span>
<span class="n">using_well_founded</span> <span class="o">{</span><span class="n">rel_tac</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">`</span><span class="o">[</span><span class="n">exact</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">measure_wf</span> <span class="n">card</span><span class="bp">⟩</span><span class="o">]}</span>
</pre></div>

<p>The final line tells the equation compiler to use this relation. It is not necessary to fully understand the final line to be able to use well_founded tactics. The most important part is <code>⟨_, measure_wf card⟩</code> This is the well_founded instance. <code>measure_wf</code> is a proof that any relation generated from a function to the natural numbers, i.e. for a function <code>f : α → ℕ</code>, the relation <code>λ x y, f x &lt; f y</code>. The underscore is a placeholder for the relation, as it can be inferred from the type of the proof. Note that the well founded relation must be on a <code>psigma</code> type corresponding to the product of the types of the arguments after the vertical bar, if there are multiple arguments after the vertical bar.</p>
<p>In the gcd example the <code>psigma</code> type is <code>Σ&#x27; (a : ℕ), ℕ</code>. In order to solve the problem in the example where the order of the arguments was flipped, you could define a well founded relation on <code>Σ&#x27; (a : ℕ), ℕ</code> using the function <code>psigma.snd</code>, the function giving the second element of the pair, and then the error disappears.</p>
<div class="highlight"><pre><span></span><span class="n">def</span> <span class="n">gcd</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="n">y</span> <span class="mi">0</span>        <span class="o">:=</span> <span class="n">y</span>
<span class="bp">|</span> <span class="n">y</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="k">have</span> <span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">succ</span> <span class="n">x</span><span class="o">,</span> <span class="k">from</span> <span class="n">mod_lt</span> <span class="bp">_</span> <span class="err">$</span> <span class="n">succ_pos</span> <span class="bp">_</span><span class="o">,</span>
                <span class="n">gcd</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="err">%</span> <span class="n">succ</span> <span class="n">x</span><span class="o">)</span>
<span class="n">using_well_founded</span> <span class="o">{</span><span class="n">rel_tac</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">`</span><span class="o">[</span><span class="n">exact</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">measure_wf</span> <span class="n">psigma</span><span class="bp">.</span><span class="n">snd</span><span class="bp">⟩</span><span class="o">]}</span>
</pre></div>

    </div>
  </main>

<div class="container-fluid">
  <nav class="footer navbar navbar-expand-lg navbar-light bg-light justify-content-end">
  <ul class="nav">
    <li class="nav-item">
      <a class="nav-link active" href="https://github.com/leanprover-community/leanprover-community.github.io/blob/newsite/templates/extras/well_founded_recursion.md">Suggest edits to this page on GitHub</a>
    </li>
  </ul>
  </nav>
</div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script src="https://robertylewis.com/mathlib/js/bootstrap.min.js"></script>
    
  </body>
</html>